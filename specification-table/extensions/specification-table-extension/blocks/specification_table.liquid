{% comment %}
  Block pentru afiÈ™area tabelului de specificaÈ›ii
  Se conecteazÄƒ la API-ul app-ului pentru a obÈ›ine template-ul
{% endcomment %}

<link rel="stylesheet" href="{{ 'specification-table.css' | asset_url }}">
<script src="{{ 'specification_table.js' | asset_url }}" defer></script>

{% assign product_id = product.id | default: block.settings.product.id %}
{% comment %} Extrage collection_id {% endcomment %}
{% assign collection_id = blank %}

{% if collection and collection.id %}
  {% assign collection_id = collection.id %}
{% elsif product and product.collections %}
  {% for collection_item in product.collections limit: 1 %}
    {% assign collection_id = collection_item.id %}
  {% endfor %}
{% elsif block.settings.collection and block.settings.collection.id %}
  {% assign collection_id = block.settings.collection.id %}
{% endif %}
{% assign shop_domain = shop.permanent_domain %}

{% comment %} Folosește metaobjects în loc de API calls {% endcomment %}
{% comment %} Pentru metafield-uri de tip metaobject_reference, .value returnează direct obiectul metaobject {% endcomment %}
{% comment %} Verifică dacă produsul are un template assignat {% endcomment %}
{% assign product_template_ref = blank %}
{% assign product_metafield_exists = false %}
{% assign product_metafield_has_value = false %}
{% if product.metafields.custom.dc_specification_template %}
  {% assign product_metafield_exists = true %}
  {% comment %} Pentru metaobject_reference, .value returnează direct obiectul metaobject {% endcomment %}
  {% comment %} IMPORTANT: Verificăm dacă .value există ȘI nu este blank {% endcomment %}
  {% assign product_metafield_value = product.metafields.custom.dc_specification_template.value %}
  {% if product_metafield_value != blank and product_metafield_value != null %}
    {% assign product_template_ref = product_metafield_value %}
    {% comment %} Dacă .value nu este blank, metaobject-ul există și este valid {% endcomment %}
    {% assign product_metafield_has_value = true %}
  {% endif %}
{% endif %}

{% comment %} Verifică dacă colecția are un template assignat {% endcomment %}
{% assign collection_template_ref = blank %}
{% assign collection_metafield_exists = false %}
{% assign collection_metafield_has_value = false %}
{% if product.collections.size > 0 %}
  {% for collection_item in product.collections %}
    {% if collection_item.metafields.custom.dc_specification_template %}
      {% assign collection_metafield_exists = true %}
      {% comment %} Pentru metaobject_reference, .value returnează direct obiectul metaobject {% endcomment %}
      {% comment %} IMPORTANT: Verificăm dacă .value există ȘI nu este blank {% endcomment %}
      {% assign collection_metafield_value = collection_item.metafields.custom.dc_specification_template.value %}
      {% if collection_metafield_value != blank and collection_metafield_value != null %}
        {% assign collection_template_ref = collection_metafield_value %}
        {% comment %} Dacă .value nu este blank, metaobject-ul există și este valid {% endcomment %}
        {% assign collection_metafield_has_value = true %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

{% comment %} Debug: Afișează starea metafield-urilor {% endcomment %}
{% assign debug_product_template_ref_exists = false %}
{% if product_template_ref != blank %}{% assign debug_product_template_ref_exists = true %}{% endif %}
{% assign debug_collection_template_ref_exists = false %}
{% if collection_template_ref != blank %}{% assign debug_collection_template_ref_exists = true %}{% endif %}
{% comment %} Debug: Verifică tipul metafield-ului și valoarea sa {% endcomment %}
{% assign debug_product_metafield_type = 'unknown' %}
{% assign debug_product_metafield_value_type = 'unknown' %}
{% if product.metafields.custom.dc_specification_template %}
  {% assign debug_product_metafield_type = product.metafields.custom.dc_specification_template.type %}
  {% if product.metafields.custom.dc_specification_template.value %}
    {% assign debug_product_metafield_value_type = 'has_value' %}
  {% else %}
    {% assign debug_product_metafield_value_type = 'no_value' %}
  {% endif %}
{% endif %}
{% comment %} Debug: Verifică valoarea metafield-ului pentru produs {% endcomment %}
{% assign debug_product_metafield_value_blank = false %}
{% if product.metafields.custom.dc_specification_template %}
  {% assign debug_product_metafield_value_check = product.metafields.custom.dc_specification_template.value %}
  {% if debug_product_metafield_value_check == blank %}{% assign debug_product_metafield_value_blank = true %}{% endif %}
{% endif %}
{% comment %} Debug: Verifică structura metaobject-ului pentru produs {% endcomment %}
{% assign debug_product_has_system = false %}
{% assign debug_product_has_template_id = false %}
{% assign debug_product_has_template_structure = false %}
{% if product_template_ref != blank %}
  {% if product_template_ref.system %}{% assign debug_product_has_system = true %}{% endif %}
  {% if product_template_ref.template_id %}{% assign debug_product_has_template_id = true %}{% endif %}
  {% if product_template_ref.template_structure %}{% assign debug_product_has_template_structure = true %}{% endif %}
{% endif %}
<script>
  console.log('[SpecificationTable Liquid] Metafield check:', {
    productMetafieldExists: {{ product_metafield_exists | json }},
    productMetafieldType: {{ debug_product_metafield_type | json }},
    productMetafieldValueType: {{ debug_product_metafield_value_type | json }},
    productMetafieldValueIsBlank: {{ debug_product_metafield_value_blank | json }},
    productTemplateRefExists: {{ debug_product_template_ref_exists | json }},
    productHasSystem: {{ debug_product_has_system | json }},
    productHasTemplateId: {{ debug_product_has_template_id | json }},
    productHasTemplateStructure: {{ debug_product_has_template_structure | json }},
    productMetafieldHasValue: {{ product_metafield_has_value | json }},
    collectionMetafieldExists: {{ collection_metafield_exists | json }},
    collectionMetafieldHasValue: {{ collection_metafield_has_value | json }},
    collectionTemplateRefExists: {{ debug_collection_template_ref_exists | json }}
  });
</script>

{% assign template_metaobject = blank %}
{% assign template_source = 'none' %}
{% comment %} Prioritate: 1. Template de produs, 2. Template de colecție, 3. Template global {% endcomment %}
{% comment %} IMPORTANT: Verificăm dacă referințele nu sunt blank înainte de a le folosi {% endcomment %}
{% comment %} Pentru metaobject_reference, obiectul metaobject este întotdeauna truthy dacă există, deci verificăm direct {% endcomment %}
{% if product_metafield_has_value and product_template_ref %}
  {% assign template_metaobject = product_template_ref %}
  {% assign template_source = 'product' %}
{% elsif collection_metafield_has_value and collection_template_ref %}
  {% assign template_metaobject = collection_template_ref %}
  {% assign template_source = 'collection' %}
{% else %}
  {% comment %} Folosește template-ul global {% endcomment %}
  {% assign global_template_handle = 'specification_template_global' %}
  {% assign metaobject_type = 'specification_template' %}
  
  {% comment %} Debug: Verifică dacă metaobjects este disponibil {% endcomment %}
  {% assign has_metaobjects = false %}
  {% if metaobjects %}{% assign has_metaobjects = true %}{% endif %}
  
  {% comment %} Încearcă să acceseze metaobject-ul global {% endcomment %}
  {% assign template_metaobject = metaobjects[metaobject_type][global_template_handle] %}
  
  {% comment %} Debug logging pentru template-ul global {% endcomment %}
  {% assign debug_found_direct = false %}
  {% if template_metaobject != blank %}{% assign debug_found_direct = true %}{% endif %}
  {% assign debug_metaobjects_spec_exists = false %}
  {% if metaobjects.specification_template != blank %}{% assign debug_metaobjects_spec_exists = true %}{% endif %}
  <script>
    console.log('[SpecificationTable Liquid] Global template search:', {
      hasMetaobjects: {{ has_metaobjects | json }},
      metaobjectType: {{ metaobject_type | json }},
      globalHandle: {{ global_template_handle | json }},
      foundDirect: {{ debug_found_direct | json }},
      metaobjectsSpecificationTemplateExists: {{ debug_metaobjects_spec_exists | json }},
      metaobjectsType: typeof {{ metaobjects[metaobject_type] | json }}
    });
  </script>
  
  {% if template_metaobject %}
    {% assign template_source = 'global' %}
  {% endif %}
{% endif %}

{% comment %} Debug: Afișează sursa template-ului {% endcomment %}
{% assign debug_has_template_metaobject = false %}
{% if template_metaobject != blank %}{% assign debug_has_template_metaobject = true %}{% endif %}
{% assign debug_has_product_ref = false %}
{% if product_template_ref != blank %}{% assign debug_has_product_ref = true %}{% endif %}
{% assign debug_has_collection_ref = false %}
{% if collection_template_ref != blank %}{% assign debug_has_collection_ref = true %}{% endif %}
<script>
  console.log('[SpecificationTable Liquid] Template priority check:', {
    source: {{ template_source | json }},
    hasProductTemplate: {{ debug_has_product_ref | json }},
    hasCollectionTemplate: {{ debug_has_collection_ref | json }},
    hasTemplateMetaobject: {{ debug_has_template_metaobject | json }},
    priority: '1. Product → 2. Collection → 3. Global'
  });
</script>

{% if template_metaobject %}
  {% comment %} Accesează valorile din metaobject {% endcomment %}
  {% comment %} Pentru metaobjects accesate prin metafield reference (produs/colecție), folosim .field_name.value {% endcomment %}
  {% comment %} Pentru metaobjects accesate direct (global), poate fi diferit {% endcomment %}
  
  {% if template_source == 'global' %}
    {% comment %} Pentru template-ul global, câmpurile JSON sunt string-uri JSON (din .value) {% endcomment %}
    {% assign template_structure_json = template_metaobject.template_structure.value %}
    {% assign template_styling_json = template_metaobject.template_styling.value %}
    {% assign template_settings_json = template_metaobject.template_settings.value %}
    {% assign template_id_value = template_metaobject.template_id.value %}
  {% else %}
    {% comment %} Pentru template-urile de produs/colecție (metafield reference), folosim .value {% endcomment %}
    {% assign template_structure_json = template_metaobject.template_structure.value %}
    {% assign template_styling_json = template_metaobject.template_styling.value %}
    {% assign template_settings_json = template_metaobject.template_settings.value %}
    {% assign template_id_value = template_metaobject.template_id.value %}
  {% endif %}
  
  {% comment %} Debug: Afișează structura metaobject-ului pentru debugging {% endcomment %}
  {% assign debug_has_structure_direct = false %}
  {% assign debug_has_structure_value = false %}
  {% assign debug_has_styling_direct = false %}
  {% assign debug_has_styling_value = false %}
  {% assign debug_has_settings_direct = false %}
  {% assign debug_has_settings_value = false %}
  {% assign debug_has_id_direct = false %}
  {% assign debug_has_id_value = false %}
  {% if template_metaobject.template_structure != blank %}{% assign debug_has_structure_direct = true %}{% endif %}
  {% if template_metaobject.template_structure.value != blank %}{% assign debug_has_structure_value = true %}{% endif %}
  {% if template_metaobject.template_styling != blank %}{% assign debug_has_styling_direct = true %}{% endif %}
  {% if template_metaobject.template_styling.value != blank %}{% assign debug_has_styling_value = true %}{% endif %}
  {% if template_metaobject.template_settings != blank %}{% assign debug_has_settings_direct = true %}{% endif %}
  {% if template_metaobject.template_settings.value != blank %}{% assign debug_has_settings_value = true %}{% endif %}
  {% if template_metaobject.template_id != blank %}{% assign debug_has_id_direct = true %}{% endif %}
  {% if template_metaobject.template_id.value != blank %}{% assign debug_has_id_value = true %}{% endif %}
  
  {% comment %} Debug specific pentru template_id {% endcomment %}
  {% assign debug_template_id_raw = template_metaobject.template_id %}
  {% assign debug_template_id_value = template_metaobject.template_id.value %}
  {% assign debug_template_id_final = template_id_value %}
  
  <script>
    console.log('[SpecificationTable Liquid] Template ID Debug:', {
      source: {{ template_source | json }},
      templateIdRaw: {{ debug_template_id_raw | json }},
      templateIdValue: {{ debug_template_id_value | json }},
      templateIdFinal: {{ debug_template_id_final | json }},
      hasIdDirect: {{ debug_has_id_direct | json }},
      hasIdValue: {{ debug_has_id_value | json }}
    });
    console.log('[SpecificationTable Liquid] Metaobject structure debug:', {
      structureDirect: {{ debug_has_structure_direct | json }},
      structureValue: {{ debug_has_structure_value | json }},
      stylingDirect: {{ debug_has_styling_direct | json }},
      stylingValue: {{ debug_has_styling_value | json }},
      settingsDirect: {{ debug_has_settings_direct | json }},
      settingsValue: {{ debug_has_settings_value | json }},
      idDirect: {{ debug_has_id_direct | json }},
      idValue: {{ debug_has_id_value | json }},
      {% comment %} Pentru debugging, verificăm tipul valorilor fără a folosi | json pe obiecte {% endcomment %}
      {% assign debug_structure_type = 'unknown' %}
      {% if template_structure_json == blank %}{% assign debug_structure_type = 'blank' %}
      {% elsif template_source == 'global' %}{% assign debug_structure_type = 'global-object' %}
      {% else %}{% assign debug_structure_type = 'string' %}{% endif %}
      {% assign debug_structure_exists = false %}
      {% if template_structure_json != blank %}{% assign debug_structure_exists = true %}{% endif %}
      {% assign debug_styling_exists = false %}
      {% if template_styling_json != blank %}{% assign debug_styling_exists = true %}{% endif %}
      {% assign debug_settings_exists = false %}
      {% if template_settings_json != blank %}{% assign debug_settings_exists = true %}{% endif %}
      finalStructureType: {{ debug_structure_type | json }},
      {% comment %} Nu folosim | json pe obiecte pentru a evita eroarea "json not allowed" {% endcomment %}
      finalStructureExists: {{ debug_structure_exists | json }},
      finalStylingExists: {{ debug_styling_exists | json }},
      finalSettingsExists: {{ debug_settings_exists | json }},
      finalId: {{ template_id_value | json }}
    });
  </script>
  
  {% comment %} Debug: Verifică dacă valorile există {% endcomment %}
  {% if template_structure_json == blank or template_styling_json == blank or template_settings_json == blank %}
    {% assign has_structure = false %}
    {% assign has_styling = false %}
    {% assign has_settings = false %}
    {% assign has_id = false %}
    {% if template_structure_json != blank %}{% assign has_structure = true %}{% endif %}
    {% if template_styling_json != blank %}{% assign has_styling = true %}{% endif %}
    {% if template_settings_json != blank %}{% assign has_settings = true %}{% endif %}
    {% if template_id_value != blank %}{% assign has_id = true %}{% endif %}
    <script>
      console.error('[SpecificationTable Liquid] Template metaobject found but values are missing:', {
        hasStructure: {{ has_structure | json }},
        hasStyling: {{ has_styling | json }},
        hasSettings: {{ has_settings | json }},
        hasId: {{ has_id | json }}
      });
    </script>
  {% endif %}
{% endif %}

{% comment %} Container pentru template {% endcomment %}
{% assign max_width = block.settings.max_width | default: 1200 %}
{% assign alignment = block.settings.alignment | default: 'left' %}
{% assign margin_top = block.settings.margin_top | default: 0 %}
{% assign margin_left = block.settings.margin_left | default: 0 %}
{% comment %} first_column_width a fost mutat în Column Ratio din admin UI {% endcomment %}
{% assign first_column_width = 40 %}
{% assign image_height = block.settings.image_height | default: 100 %}

<div id="specification-table-container-{{ block.id }}" 
     data-product-id="{{ product_id }}" 
     {% if collection_id != blank %}data-collection-id="{{ collection_id }}"{% endif %}
     data-shop="{{ shop_domain }}"
     data-max-width="{{ max_width }}"
     data-alignment="{{ alignment }}"
     data-margin-top="{{ margin_top }}"
     data-margin-left="{{ margin_left }}"
     data-first-column-width="{{ first_column_width }}"
     data-image-height="{{ image_height }}"
     style="max-width: {{ max_width }}px; margin-top: {{ margin_top }}px; {% if alignment == 'center' %}margin-left: auto; margin-right: auto;{% elsif alignment == 'right' %}margin-left: auto; margin-right: {{ margin_left }}px;{% else %}margin-left: {{ margin_left }}px;{% endif %}">
  <div class="spec-loading" style="text-align: center; padding: 20px;">
    Loading specifications...
  </div>
</div>

{% comment %} Debug: Afișează informații despre metafield-uri - rulează întotdeauna {% endcomment %}
{% assign debug_has_product_template = false %}
{% assign debug_has_collection_template = false %}
{% assign debug_has_template_metaobject = false %}
{% assign debug_template_structure_exists = false %}
{% assign debug_template_styling_exists = false %}
{% assign debug_template_settings_exists = false %}
{% assign debug_template_id_exists = false %}
{% if product_template_ref != blank %}{% assign debug_has_product_template = true %}{% endif %}
{% if collection_template_ref != blank %}{% assign debug_has_collection_template = true %}{% endif %}
{% if template_metaobject != blank %}{% assign debug_has_template_metaobject = true %}{% endif %}
{% if template_structure_json != blank %}{% assign debug_template_structure_exists = true %}{% endif %}
{% if template_styling_json != blank %}{% assign debug_template_styling_exists = true %}{% endif %}
{% if template_settings_json != blank %}{% assign debug_template_settings_exists = true %}{% endif %}
{% if template_id_value != blank %}{% assign debug_template_id_exists = true %}{% endif %}
<script>
  console.log('[SpecificationTable Liquid Debug]', {
    hasProductTemplate: {{ debug_has_product_template | json }},
    hasCollectionTemplate: {{ debug_has_collection_template | json }},
    hasTemplateMetaobject: {{ debug_has_template_metaobject | json }},
    collectionsCount: {{ product.collections.size | json }},
    templateStructureExists: {{ debug_template_structure_exists | json }},
    templateStylingExists: {{ debug_template_styling_exists | json }},
    templateSettingsExists: {{ debug_template_settings_exists | json }},
    templateIdExists: {{ debug_template_id_exists | json }}
  });
  
  {% if product.collections.size > 0 %}
    console.log('[SpecificationTable Liquid Debug] Collections:', [
      {% for collection_item in product.collections %}
        {% assign collection_has_metafield = false %}
        {% if collection_item.metafields.custom.dc_specification_template != blank %}{% assign collection_has_metafield = true %}{% endif %}
        {
          id: {{ collection_item.id | json }},
          title: {{ collection_item.title | json }},
          hasMetafield: {{ collection_has_metafield | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]);
  {% endif %}
</script>

{% if template_metaobject and template_structure_json != blank and template_styling_json != blank and template_settings_json != blank %}
<script>
  // Setează datele template-ului direct în JavaScript
  // Pentru template-ul global, câmpurile JSON pot fi obiecte, nu string-uri
  // Trebuie să le convertim corect în string-uri JSON
  {% if template_source == 'global' %}
    {% comment %} Pentru template-ul global, câmpurile JSON sunt string-uri JSON (din .value) {% endcomment %}
    {% comment %} Folosim | json pentru a escapa corect string-urile JSON {% endcomment %}
    window.templateData_{{ block.id }} = {
      structure: {{ template_structure_json | json }},
      styling: {{ template_styling_json | json }},
      settings: {{ template_settings_json | json }},
      id: {{ template_id_value | json }}
    };
    
    {% comment %} Dacă valorile sunt string-uri JSON, le parsăm în obiecte JavaScript {% endcomment %}
    {% comment %} Verifică dacă sunt string-uri (încep cu " sau {) și le parsează {% endcomment %}
    if (typeof window.templateData_{{ block.id }}.structure === 'string') {
      try {
        window.templateData_{{ block.id }}.structure = JSON.parse(window.templateData_{{ block.id }}.structure);
      } catch(e) {
        console.error('[SpecificationTable] Error parsing structure JSON:', e, 'Raw value:', window.templateData_{{ block.id }}.structure);
      }
    }
    if (typeof window.templateData_{{ block.id }}.styling === 'string') {
      try {
        window.templateData_{{ block.id }}.styling = JSON.parse(window.templateData_{{ block.id }}.styling);
      } catch(e) {
        console.error('[SpecificationTable] Error parsing styling JSON:', e, 'Raw value:', window.templateData_{{ block.id }}.styling);
      }
    }
    if (typeof window.templateData_{{ block.id }}.settings === 'string') {
      try {
        window.templateData_{{ block.id }}.settings = JSON.parse(window.templateData_{{ block.id }}.settings);
      } catch(e) {
        console.error('[SpecificationTable] Error parsing settings JSON:', e, 'Raw value:', window.templateData_{{ block.id }}.settings);
      }
    }
  {% else %}
    {% comment %} Pentru template-urile de produs/colecție, valorile sunt deja string-uri JSON {% endcomment %}
    window.templateData_{{ block.id }} = {
      structure: {{ template_structure_json | json }},
      styling: {{ template_styling_json | json }},
      settings: {{ template_settings_json | json }},
      id: {{ template_id_value | json }}
    };
  {% endif %}
  
  // Debug: Log template source
  {% assign debug_using_global = false %}
  {% if product_template_ref == blank and collection_template_ref == blank %}{% assign debug_using_global = true %}{% endif %}
  console.log('[SpecificationTable Debug] Template source:', {
    hasProductTemplate: {{ debug_has_product_template | json }},
    hasCollectionTemplate: {{ debug_has_collection_template | json }},
    usingGlobal: {{ debug_using_global | json }},
    templateId: {{ template_id_value | json }},
    collectionsCount: {{ product.collections.size | json }}
  });
</script>
{% endif %}

{% comment %} 
  ConstruieÈ™te obiectul JavaScript cu toate metafield-urile disponibile din Liquid
  FoloseÈ™te informaÈ›iile din baza de date (toate metafield definitions) pentru a construi dinamic codul Liquid
  Template-ul ne spune ce metafield-uri sÄƒ afiÈ™Äƒm, iar valorile le obÈ›inem direct din Liquid
{% endcomment %}

{% if product %}
<script>
  // IniÈ›ializeazÄƒ obiectele pentru metafield-uri
  window.productMetafieldsData = {};
  window.variantMetafieldsData = {};
  
  // FuncÈ›ie helper pentru a construi obiectul JavaScript cu metafield-urile din Liquid
  // FoloseÈ™te informaÈ›iile din template pentru a accesa valorile direct din Liquid
  // NOTÄ‚: Valorile sunt deja construite Ã®n Liquid mai jos, aceastÄƒ funcÈ›ie doar le filtreazÄƒ
  window.buildMetafieldsFromTemplate = function(template, allMetafieldDefinitions) {
    // CreeazÄƒ un map pentru a gÄƒsi rapid tipul unui metafield
    const metafieldTypeMap = {};
    if (allMetafieldDefinitions) {
      allMetafieldDefinitions.forEach(mf => {
        const key = `${mf.namespace}.${mf.key}.${mf.ownerType}`;
        metafieldTypeMap[key] = mf.type;
      });
    }
    
    // FiltreazÄƒ doar metafield-urile care sunt Ã®n template din obiectul global construit Ã®n Liquid
    const filteredProductMetafields = {};
    const filteredVariantMetafields = {};
    
    // FoloseÈ™te obiectul global construit Ã®n Liquid (mai jos)
    const allProductMetafields = window.allProductMetafieldsFromLiquid || {};
    const allVariantMetafields = window.allVariantMetafieldsFromLiquid || {};
    
    if (template && template.sections) {
      template.sections.forEach(section => {
        section.metafields.forEach(mf => {
          const metafieldKey = `${mf.namespace}.${mf.key}.${mf.ownerType}`;
          const metafieldType = mf.type || metafieldTypeMap[metafieldKey] || 'single_line_text_field';
          
          if (mf.ownerType === 'PRODUCT') {
            if (allProductMetafields[mf.namespace] && allProductMetafields[mf.namespace][mf.key] !== undefined) {
              if (!filteredProductMetafields[mf.namespace]) {
                filteredProductMetafields[mf.namespace] = {};
              }
              let value = allProductMetafields[mf.namespace][mf.key];
              
              // ProceseazÄƒ special file_reference, product_reference È™i collection_reference
              if (metafieldType === 'file_reference' && value) {
                // Pentru file_reference, valoarea este deja procesatÄƒ Ã®n Liquid cu image_url
                // Trebuie sÄƒ folosim valoarea directÄƒ din obiectul construit Ã®n Liquid
                filteredProductMetafields[mf.namespace][mf.key] = value;
              } else if (metafieldType === 'product_reference' && value && typeof value === 'object') {
                // Pentru product_reference, valoarea este deja un obiect Product
                filteredProductMetafields[mf.namespace][mf.key] = value;
              } else if (metafieldType === 'collection_reference' && value && typeof value === 'object') {
                // Pentru collection_reference, valoarea este deja un obiect Collection
                filteredProductMetafields[mf.namespace][mf.key] = value;
              } else {
                filteredProductMetafields[mf.namespace][mf.key] = value;
              }
            }
          } else if (mf.ownerType === 'VARIANT') {
            // Pentru variante, copiem toate variantele (vor fi filtrate la afiÈ™are)
            Object.keys(allVariantMetafields).forEach(variantId => {
              if (allVariantMetafields[variantId][mf.namespace] && allVariantMetafields[variantId][mf.namespace][mf.key] !== undefined) {
                if (!filteredVariantMetafields[variantId]) {
                  filteredVariantMetafields[variantId] = {};
                }
                if (!filteredVariantMetafields[variantId][mf.namespace]) {
                  filteredVariantMetafields[variantId][mf.namespace] = {};
                }
                let value = allVariantMetafields[variantId][mf.namespace][mf.key];
                
                // ProceseazÄƒ special file_reference, product_reference È™i collection_reference
                if (metafieldType === 'file_reference' && value) {
                  // Pentru file_reference, valoarea este deja procesatÄƒ Ã®n Liquid cu image_url
                  filteredVariantMetafields[variantId][mf.namespace][mf.key] = value;
                } else if (metafieldType === 'product_reference' && value && typeof value === 'object') {
                  // Pentru product_reference, valoarea este deja un obiect Product
                  filteredVariantMetafields[variantId][mf.namespace][mf.key] = value;
                } else if (metafieldType === 'collection_reference' && value && typeof value === 'object') {
                  // Pentru collection_reference, valoarea este deja un obiect Collection
                  filteredVariantMetafields[variantId][mf.namespace][mf.key] = value;
                } else {
                  filteredVariantMetafields[variantId][mf.namespace][mf.key] = value;
                }
              }
            });
          }
        });
      });
    }
    
    window.productMetafieldsData = filteredProductMetafields;
    window.variantMetafieldsData = filteredVariantMetafields;
    
    return { productMetafields: filteredProductMetafields, variantMetafields: filteredVariantMetafields };
  };
  
  // ConstruieÈ™te obiectul JavaScript cu TOATE metafield-urile disponibile din Liquid
  // Acest obiect este construit direct Ã®n Liquid folosind toate metafield-urile disponibile
  // Pentru file_reference, folosim image_url filter pentru a obÈ›ine URL-ul imaginii
  console.log('[Liquid] Building allProductMetafieldsFromLiquid...');
  window.allProductMetafieldsFromLiquid = {
    {% comment %} ConstruieÈ™te pentru namespace-ul 'custom' {% endcomment %}
    {% if product.metafields.custom %}
    custom: {
      {% for metafield_pair in product.metafields.custom %}
        {% assign mf_key = metafield_pair[0] %}
        {% assign mf_value = metafield_pair[1] %}
        {% comment %} Pentru file_reference, verificăm dacă este imagine/video sau alt tip de fișier {% endcomment %}
        {% if mf_value.type == 'file_reference' %}
          {% if mf_value.value != blank %}
            {% assign file = mf_value.value %}
            {% comment %} Verifică media_type pentru a diferenția între imagine, video și fișier {% endcomment %}
            {% assign media_type = file.media_type | default: '' %}
            {% if media_type == 'image' %}
              {% comment %} Este imagine - folosim image_url {% endcomment %}
              '{{ mf_key }}': '{{ file | image_url }}'{% unless forloop.last %},{% endunless %}
            {% elsif media_type == 'video' %}
              {% comment %} Este video - construim obiectul cu url, filename, alt și media_type {% endcomment %}
              {% comment %} Pentru video, verificăm dacă există sources array, altfel folosim originalSourceUrl sau url {% endcomment %}
              {% if file.sources.size > 0 %}
                {% assign video_url = file.sources[0].url %}
              {% elsif file.originalSourceUrl %}
                {% assign video_url = file.originalSourceUrl %}
              {% else %}
                {% assign video_url = file.url %}
              {% endif %}
              {% unless video_url contains 'http' %}
                {% assign video_url = 'https:' | append: video_url %}
              {% endunless %}
              {% assign filename = file.filename | default: video_url | split: '/' | last | split: '?' | first %}
              {% assign file_alt = file.alt | default: filename %}
              {% assign video_url_escaped = video_url | json %}
              {% assign file_filename_escaped = filename | json %}
              {% assign file_alt_escaped = file_alt | json %}
              '{{ mf_key }}': {"url": {{ video_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}, "media_type": "video"}{% unless forloop.last %},{% endunless %}
            {% else %}
              {% comment %} Este fișier (generic_file sau alt tip) - construim obiectul cu url, filename, alt {% endcomment %}
              {% assign file_url = file.originalSourceUrl | default: file.url %}
              {% assign filename = file.filename | default: file_url | split: '/' | last | split: '?' | first %}
              {% assign download_url = file_url %}
              {% unless download_url contains 'http' %}
                {% assign download_url = 'https:' | append: download_url %}
              {% endunless %}
              {% assign file_alt = file.alt | default: filename %}
              {% assign file_url_escaped = download_url | json %}
              {% assign file_filename_escaped = filename | json %}
              {% assign file_alt_escaped = file_alt | json %}
              '{{ mf_key }}': {"url": {{ file_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}}{% unless forloop.last %},{% endunless %}
            {% endif %}
          {% else %}
            '{{ mf_key }}': null{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% elsif mf_value.type == 'product_reference' %}
          '{{ mf_key }}': {% if mf_value.value %}{% assign ref_product = mf_value.value %}{"title": {{ ref_product.title | json }}, "featured_image": {% if ref_product.featured_image %}"{{ ref_product.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_product.url %}{{ ref_product.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'collection_reference' %}
          '{{ mf_key }}': {% if mf_value.value %}{% assign ref_collection = mf_value.value %}{"title": {{ ref_collection.title | json }}, "featured_image": {% if ref_collection.featured_image %}"{{ ref_collection.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_collection.url %}{{ ref_collection.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'dimension' %}
          '{{ mf_key }}': {% if mf_value.value != blank %}{% if mf_value.value.value != blank and mf_value.value.unit != blank %}'{{ mf_value.value.value }} {{ mf_value.value.unit }}'{% elsif mf_value.value.value != blank %}'{{ mf_value.value.value }}'{% else %}null{% endif %}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'rating' %}
          {% if mf_value.value != blank %}
            {% comment %} Pentru rating, accesăm direct proprietățile obiectului {% endcomment %}
            {% assign rating_obj = mf_value.value %}
            {% comment %} Încearcă mai multe moduri de accesare a valorii {% endcomment %}
            {% if rating_obj.value != blank %}
              {% assign rating_value = rating_obj.value %}
            {% elsif rating_obj != blank %}
              {% assign rating_value = rating_obj %}
        {% else %}
              {% assign rating_value = '0' %}
            {% endif %}
            {% assign rating_scale_max = rating_obj.scale_max | default: '5' %}
            {% assign rating_scale_min = rating_obj.scale_min | default: '1' %}
            '{{ mf_key }}': {"scale_min": {{ rating_scale_min }}, "scale_max": {{ rating_scale_max }}, "value": {{ rating_value }}}{% unless forloop.last %},{% endunless %}
          {% else %}
            '{{ mf_key }}': null{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% else %}
          '{{ mf_key }}': {{ mf_value.value | json }}{% unless forloop.last %},{% endunless %}
        {% endif %}
      {% endfor %}
    }{% if product.metafields.test_data %},{% endif %}
    {% endif %}
    {% comment %} ConstruieÈ™te pentru alte namespace-uri cunoscute {% endcomment %}
    {% if product.metafields.test_data %}
    test_data: {
      {% for metafield_pair in product.metafields.test_data %}
        {% assign mf_key = metafield_pair[0] %}
        {% assign mf_value = metafield_pair[1] %}
        {% comment %} Pentru file_reference, verificăm dacă este imagine/video sau alt tip de fișier {% endcomment %}
        {% if mf_value.type == 'file_reference' %}
          {% if mf_value.value != blank %}
            {% assign file = mf_value.value %}
            {% comment %} Verifică media_type pentru a diferenția între imagine, video și fișier {% endcomment %}
            {% assign media_type = file.media_type | default: '' %}
            {% if media_type == 'image' %}
              {% comment %} Este imagine - folosim image_url {% endcomment %}
              '{{ mf_key }}': '{{ file | image_url }}'{% unless forloop.last %},{% endunless %}
            {% elsif media_type == 'video' %}
              {% comment %} Este video - construim obiectul cu url, filename, alt și media_type {% endcomment %}
              {% comment %} Pentru video, verificăm dacă există sources array, altfel folosim originalSourceUrl sau url {% endcomment %}
              {% if file.sources.size > 0 %}
                {% assign video_url = file.sources[0].url %}
              {% elsif file.originalSourceUrl %}
                {% assign video_url = file.originalSourceUrl %}
              {% else %}
                {% assign video_url = file.url %}
              {% endif %}
              {% unless video_url contains 'http' %}
                {% assign video_url = 'https:' | append: video_url %}
              {% endunless %}
              {% assign filename = file.filename | default: video_url | split: '/' | last | split: '?' | first %}
              {% assign file_alt = file.alt | default: filename %}
              {% assign video_url_escaped = video_url | json %}
              {% assign file_filename_escaped = filename | json %}
              {% assign file_alt_escaped = file_alt | json %}
              '{{ mf_key }}': {"url": {{ video_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}, "media_type": "video"}{% unless forloop.last %},{% endunless %}
            {% else %}
              {% comment %} Este fișier (generic_file sau alt tip) - construim obiectul cu url, filename, alt {% endcomment %}
              {% assign file_url = file.originalSourceUrl | default: file.url %}
              {% assign filename = file.filename | default: file_url | split: '/' | last | split: '?' | first %}
              {% assign download_url = file_url %}
              {% unless download_url contains 'http' %}
                {% assign download_url = 'https:' | append: download_url %}
              {% endunless %}
              {% assign file_alt = file.alt | default: filename %}
              {% assign file_url_escaped = download_url | json %}
              {% assign file_filename_escaped = filename | json %}
              {% assign file_alt_escaped = file_alt | json %}
              '{{ mf_key }}': {"url": {{ file_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}}{% unless forloop.last %},{% endunless %}
            {% endif %}
          {% else %}
            '{{ mf_key }}': null{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% elsif mf_value.type == 'product_reference' %}
          '{{ mf_key }}': {% if mf_value.value %}{% assign ref_product = mf_value.value %}{"title": {{ ref_product.title | json }}, "featured_image": {% if ref_product.featured_image %}"{{ ref_product.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_product.url %}{{ ref_product.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'collection_reference' %}
          '{{ mf_key }}': {% if mf_value.value %}{% assign ref_collection = mf_value.value %}{"title": {{ ref_collection.title | json }}, "featured_image": {% if ref_collection.featured_image %}"{{ ref_collection.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_collection.url %}{{ ref_collection.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'dimension' %}
          '{{ mf_key }}': {% if mf_value.value != blank %}{% if mf_value.value.value != blank and mf_value.value.unit != blank %}'{{ mf_value.value.value }} {{ mf_value.value.unit }}'{% elsif mf_value.value.value != blank %}'{{ mf_value.value.value }}'{% else %}null{% endif %}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
        {% elsif mf_value.type == 'rating' %}
          {% if mf_value.value != blank %}
            {% comment %} Pentru rating, accesăm direct proprietățile obiectului {% endcomment %}
            {% assign rating_obj = mf_value.value %}
            {% comment %} Încearcă mai multe moduri de accesare a valorii {% endcomment %}
            {% if rating_obj.value != blank %}
              {% assign rating_value = rating_obj.value %}
            {% elsif rating_obj != blank %}
              {% assign rating_value = rating_obj %}
        {% else %}
              {% assign rating_value = '0' %}
            {% endif %}
            {% assign rating_scale_max = rating_obj.scale_max | default: '5' %}
            {% assign rating_scale_min = rating_obj.scale_min | default: '1' %}
            '{{ mf_key }}': {"scale_min": {{ rating_scale_min }}, "scale_max": {{ rating_scale_max }}, "value": {{ rating_value }}}{% unless forloop.last %},{% endunless %}
          {% else %}
            '{{ mf_key }}': null{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% else %}
          '{{ mf_key }}': {{ mf_value.value | json }}{% unless forloop.last %},{% endunless %}
        {% endif %}
      {% endfor %}
    }
    {% endif %}
  };
  
  // ConstruieÈ™te obiectul JavaScript cu TOATE product specifications disponibile din Liquid
  {% assign current_variant = product.selected_or_first_available_variant %}
  window.productSpecsFromLiquid = {
    vendor: {% if product.vendor != blank %}{{ product.vendor | json }}{% else %}null{% endif %},
    inventory_quantity: {% if current_variant %}{% if current_variant.inventory_quantity != blank %}{{ current_variant.inventory_quantity }}{% else %}0{% endif %}{% else %}null{% endif %},
    weight: {% if current_variant and current_variant.weight != blank %}{{ current_variant.weight }}{% else %}null{% endif %},
    weight_unit: {% if current_variant and current_variant.weight_unit != blank %}{{ current_variant.weight_unit | json }}{% else %}null{% endif %},
    sku: {% if current_variant and current_variant.sku != blank %}{{ current_variant.sku | json }}{% else %}null{% endif %},
    barcode: {% if current_variant and current_variant.barcode != blank %}{{ current_variant.barcode | json }}{% else %}null{% endif %},
    variant_sku: {% if current_variant and current_variant.sku != blank %}{{ current_variant.sku | json }}{% else %}null{% endif %},
    compare_at_price: {% if current_variant and current_variant.compare_at_price != blank %}{{ current_variant.compare_at_price }}{% else %}null{% endif %},
    product_type: {% if product.type != blank %}{{ product.type | json }}{% else %}null{% endif %},
    collection_names: {% if product.collections.size > 0 %}{% assign collection_names_array = '' %}{% for collection in product.collections %}{% if forloop.first %}{% assign collection_names_array = collection.title %}{% else %}{% assign collection_names_array = collection_names_array | append: ', ' | append: collection.title %}{% endif %}{% endfor %}{{ collection_names_array | json }}{% else %}null{% endif %}
  };
  
  // ConstruieÈ™te obiectul JavaScript cu TOATE metafield-urile VARIANT disponibile din Liquid
  // Folosim varianta curentÄƒ (selected_or_first_available_variant) pentru a obÈ›ine metafield-urile
  // Pentru file_reference, folosim image_url filter pentru a obÈ›ine URL-ul imaginii
  window.allVariantMetafieldsFromLiquid = {};
  {% if product.selected_or_first_available_variant %}
    {% assign current_variant_id = product.selected_or_first_available_variant.id | split: '/' | last %}
    window.allVariantMetafieldsFromLiquid['{{ current_variant_id }}'] = {
      {% if product.selected_or_first_available_variant.metafields.custom %}
      custom: {
        {% for variant_mf_pair in product.selected_or_first_available_variant.metafields.custom %}
          {% assign variant_mf_key = variant_mf_pair[0] %}
          {% assign variant_mf_value = variant_mf_pair[1] %}
          {% comment %} Pentru file_reference, verificăm dacă este imagine/video sau alt tip de fișier {% endcomment %}
          {% if variant_mf_value.type == 'file_reference' %}
            {% if variant_mf_value.value != blank %}
              {% assign file = variant_mf_value.value %}
              {% comment %} Verifică media_type pentru a diferenția între imagine, video și fișier {% endcomment %}
              {% assign media_type = file.media_type | default: '' %}
              {% if media_type == 'image' %}
                {% comment %} Este imagine - folosim image_url {% endcomment %}
                '{{ variant_mf_key }}': '{{ file | image_url }}'{% unless forloop.last %},{% endunless %}
              {% elsif media_type == 'video' %}
                {% comment %} Este video - construim obiectul cu url, filename, alt și media_type {% endcomment %}
                {% comment %} Pentru video, verificăm dacă există sources array, altfel folosim originalSourceUrl sau url {% endcomment %}
                {% if file.sources.size > 0 %}
                  {% assign video_url = file.sources[0].url %}
                {% elsif file.originalSourceUrl %}
                  {% assign video_url = file.originalSourceUrl %}
                {% else %}
                  {% assign video_url = file.url %}
                {% endif %}
                {% unless video_url contains 'http' %}
                  {% assign video_url = 'https:' | append: video_url %}
                {% endunless %}
                {% assign filename = file.filename | default: video_url | split: '/' | last | split: '?' | first %}
                {% assign file_alt = file.alt | default: filename %}
                {% assign video_url_escaped = video_url | json %}
                {% assign file_filename_escaped = filename | json %}
                {% assign file_alt_escaped = file_alt | json %}
                '{{ variant_mf_key }}': {"url": {{ video_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}, "media_type": "video"}{% unless forloop.last %},{% endunless %}
              {% else %}
                {% comment %} Este fișier (generic_file sau alt tip) - construim obiectul cu url, filename, alt {% endcomment %}
                {% assign file_url = file.originalSourceUrl | default: file.url %}
                {% assign filename = file.filename | default: file_url | split: '/' | last | split: '?' | first %}
                {% assign download_url = file_url %}
                {% unless download_url contains 'http' %}
                  {% assign download_url = 'https:' | append: download_url %}
                {% endunless %}
                {% assign file_alt = file.alt | default: filename %}
                {% assign file_url_escaped = download_url | json %}
                {% assign file_filename_escaped = filename | json %}
                {% assign file_alt_escaped = file_alt | json %}
                '{{ variant_mf_key }}': {"url": {{ file_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}}{% unless forloop.last %},{% endunless %}
              {% endif %}
            {% else %}
              '{{ variant_mf_key }}': null{% unless forloop.last %},{% endunless %}
            {% endif %}
          {% elsif variant_mf_value.type == 'product_reference' %}
            '{{ variant_mf_key }}': {% if variant_mf_value.value %}{% assign ref_product = variant_mf_value.value %}{"title": {{ ref_product.title | json }}, "featured_image": {% if ref_product.featured_image %}"{{ ref_product.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_product.url %}{{ ref_product.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
          {% elsif variant_mf_value.type == 'collection_reference' %}
            '{{ variant_mf_key }}': {% if variant_mf_value.value %}{% assign ref_collection = variant_mf_value.value %}{"title": {{ ref_collection.title | json }}, "featured_image": {% if ref_collection.featured_image %}"{{ ref_collection.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}, "url": {% if ref_collection.url %}{{ ref_collection.url | json }}{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
          {% elsif variant_mf_value.type == 'dimension' %}
            '{{ variant_mf_key }}': {% if variant_mf_value.value != blank %}{% if variant_mf_value.value.value != blank and variant_mf_value.value.unit != blank %}'{{ variant_mf_value.value.value }} {{ variant_mf_value.value.unit }}'{% elsif variant_mf_value.value.value != blank %}'{{ variant_mf_value.value.value }}'{% else %}null{% endif %}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
          {% elsif variant_mf_value.type == 'rating' %}
            {% if variant_mf_value.value != blank %}
              {% comment %} Pentru rating, accesăm direct proprietățile obiectului {% endcomment %}
              {% assign rating_obj = variant_mf_value.value %}
              {% comment %} Încearcă mai multe moduri de accesare a valorii {% endcomment %}
              {% if rating_obj.value != blank %}
                {% assign rating_value = rating_obj.value %}
              {% elsif rating_obj.rating != blank %}
                {% assign rating_value = rating_obj.rating %}
              {% elsif rating_obj != blank %}
                {% assign rating_value = rating_obj %}
              {% else %}
                {% assign rating_value = '0' %}
              {% endif %}
              {% assign rating_scale_max = rating_obj.scale_max | default: '5' %}
              {% assign rating_scale_min = rating_obj.scale_min | default: '1' %}
              '{{ variant_mf_key }}': {"scale_min": {{ rating_scale_min }}, "scale_max": {{ rating_scale_max }}, "value": {{ rating_value }}}{% unless forloop.last %},{% endunless %}
            {% else %}
              '{{ variant_mf_key }}': null{% unless forloop.last %},{% endunless %}
            {% endif %}
          {% else %}
            '{{ variant_mf_key }}': {{ variant_mf_value.value | json }}{% unless forloop.last %},{% endunless %}
          {% endif %}
        {% endfor %}
      }
      {% endif %}
    };
    
    // ConstruieÈ™te È™i pentru toate celelalte variante (pentru actualizare Ã®n timp real)
    {% for variant in product.variants %}
      {% assign variant_id = variant.id | split: '/' | last %}
      {% if variant_id != current_variant_id %}
        window.allVariantMetafieldsFromLiquid['{{ variant_id }}'] = {
          {% if variant.metafields.custom %}
          custom: {
            {% for variant_mf_pair in variant.metafields.custom %}
              {% assign variant_mf_key = variant_mf_pair[0] %}
              {% assign variant_mf_value = variant_mf_pair[1] %}
              {% comment %} Pentru file_reference, verificăm dacă este imagine/video sau alt tip de fișier {% endcomment %}
              {% if variant_mf_value.type == 'file_reference' %}
                {% if variant_mf_value.value != blank %}
                  {% assign file = variant_mf_value.value %}
                  {% comment %} Verifică media_type pentru a diferenția între imagine, video și fișier {% endcomment %}
                  {% assign media_type = file.media_type | default: '' %}
                  {% if media_type == 'image' %}
                    {% comment %} Este imagine - folosim image_url {% endcomment %}
                    '{{ variant_mf_key }}': '{{ file | image_url }}'{% unless forloop.last %},{% endunless %}
                  {% elsif media_type == 'video' %}
                    {% comment %} Este video - construim obiectul cu url, filename, alt și media_type {% endcomment %}
                    {% assign file_url = file.originalSourceUrl | default: file.url %}
                    {% assign filename = file.filename | default: file_url | split: '/' | last | split: '?' | first %}
                    {% assign video_url = file_url %}
                    {% unless video_url contains 'http' %}
                      {% assign video_url = 'https:' | append: video_url %}
                    {% endunless %}
                    {% assign file_alt = file.alt | default: filename %}
                    {% assign video_url_escaped = video_url | json %}
                    {% assign file_filename_escaped = filename | json %}
                    {% assign file_alt_escaped = file_alt | json %}
                    '{{ variant_mf_key }}': {"url": {{ video_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}, "media_type": "video"}{% unless forloop.last %},{% endunless %}
                  {% else %}
                    {% comment %} Este fișier (generic_file sau alt tip) - construim obiectul cu url, filename, alt {% endcomment %}
                    {% assign file_url = file.originalSourceUrl | default: file.url %}
                    {% assign filename = file.filename | default: file_url | split: '/' | last | split: '?' | first %}
                    {% assign download_url = file_url %}
                    {% unless download_url contains 'http' %}
                      {% assign download_url = 'https:' | append: download_url %}
                    {% endunless %}
                    {% assign file_alt = file.alt | default: filename %}
                    {% assign file_url_escaped = download_url | json %}
                    {% assign file_filename_escaped = filename | json %}
                    {% assign file_alt_escaped = file_alt | json %}
                    '{{ variant_mf_key }}': {"url": {{ file_url_escaped }}, "filename": {{ file_filename_escaped }}, "alt": {{ file_alt_escaped }}}{% unless forloop.last %},{% endunless %}
                  {% endif %}
                {% else %}
                  '{{ variant_mf_key }}': null{% unless forloop.last %},{% endunless %}
                {% endif %}
              {% elsif variant_mf_value.type == 'product_reference' %}
                '{{ variant_mf_key }}': {% if variant_mf_value.value %}{% assign ref_product = variant_mf_value.value %}{"title": {{ ref_product.title | json }}, "featured_image": {% if ref_product.featured_image %}"{{ ref_product.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
              {% elsif variant_mf_value.type == 'collection_reference' %}
                '{{ variant_mf_key }}': {% if variant_mf_value.value %}{% assign ref_collection = variant_mf_value.value %}{"title": {{ ref_collection.title | json }}, "featured_image": {% if ref_collection.featured_image %}"{{ ref_collection.featured_image | image_url: width: 300 }}"{% else %}null{% endif %}}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
              {% elsif variant_mf_value.type == 'dimension' %}
                '{{ variant_mf_key }}': {% if variant_mf_value.value != blank %}{% if variant_mf_value.value.value != blank and variant_mf_value.value.unit != blank %}'{{ variant_mf_value.value.value }} {{ variant_mf_value.value.unit }}'{% elsif variant_mf_value.value.value != blank %}'{{ variant_mf_value.value.value }}'{% else %}null{% endif %}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
              {% elsif variant_mf_value.type == 'rating' %}
                {% if variant_mf_value.value != blank %}
                  {% comment %} Pentru rating, accesăm direct proprietățile obiectului {% endcomment %}
                  {% assign rating_obj = variant_mf_value.value %}
                  {% comment %} Încearcă mai multe moduri de accesare a valorii {% endcomment %}
                  {% if rating_obj.value != blank %}
                    {% assign rating_value = rating_obj.value %}
                  {% elsif rating_obj.rating != blank %}
                    {% assign rating_value = rating_obj.rating %}
                  {% elsif rating_obj != blank %}
                    {% assign rating_value = rating_obj %}
                  {% else %}
                    {% assign rating_value = '0' %}
                  {% endif %}
                  {% assign rating_scale_max = rating_obj.scale_max | default: '5' %}
                  {% assign rating_scale_min = rating_obj.scale_min | default: '1' %}
                  '{{ variant_mf_key }}': {"scale_min": {{ rating_scale_min }}, "scale_max": {{ rating_scale_max }}, "value": {{ rating_value }}}{% unless forloop.last %},{% endunless %}
              {% else %}
                  '{{ variant_mf_key }}': null{% unless forloop.last %},{% endunless %}
                {% endif %}
              {% else %}
                '{{ variant_mf_key }}': {{ variant_mf_value.value | json }}{% unless forloop.last %},{% endunless %}
              {% endif %}
            {% endfor %}
          }
          {% endif %}
        };
      {% endif %}
    {% endfor %}
  {% endif %}
</script>

<script>
(function() {
  // Așteaptă ca script-ul extern să fie încărcat
  function initWhenReady() {
    if (typeof window.initSpecificationTable !== 'undefined') {
      // Pasează datele template-ului din variabila globală
      const templateData = window.templateData_{{ block.id }};
      window.initSpecificationTable('specification-table-container-{{ block.id }}', templateData);
        } else {
      // Reîncearcă după 50ms dacă script-ul nu este încă încărcat
      setTimeout(initWhenReady, 50);
    }
  }
  
  // Încearcă să inițializeze imediat sau după ce DOM-ul este gata
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWhenReady);
      } else {
    initWhenReady();
  }
})();
</script>
{% endif %}

{% schema %}
{
  "name": "SmartSpecs Table",
  "target": "section",
  "settings": [

    {
      "type": "range",
      "id": "max_width",
      "label": "Max Width",
      "min": 100,
      "max": 2000,
      "step": 100,
      "unit": "px",
      "default": 1200
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Align",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Gap",
      "min": 0,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_left",
      "label": "Left Gap",
      "min": 0,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "image_height",
      "label": "Image Height",
      "min": 40,
      "max": 300,
      "step": 20,
      "unit": "px",
      "default": 100
    }
  ]
}
{% endschema %}
